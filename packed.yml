AWSTemplateFormatVersion: '2010-09-09'
Description: Mackerel Example Stacks

Parameters:
  projectName:
    Type: String
    Default: mackerel2
    Description: Resource prefix
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9]*
  # ssh-key
  eC2KeyPair:
    Type: AWS::EC2::KeyPair::KeyName
    Default: mackerel-key

Resources:
  VPC:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.ap-southeast-1.amazonaws.com/mackerel-bucket/4a80c3b47a37057dfea8b0dc8b3dcb8a.template
      Parameters:
        projectName:

  # EFS:
  #   Type: AWS::CloudFormation::Stack
  #   Properties:
  #     TemplateURL: 05_efs.yml
  #     Parameters:
  #       projectName: !Ref projectName
  #       vpc: !GetAtt VPC.Outputs.vpc
  #       subnet: !GetAtt VPC.Outputs.publicSubnet1

  # SSHGate:
  #   Type: AWS::CloudFormation::Stack
  #   DependsOn: EFS
  #   Properties:
  #     TemplateURL: 02_ssh_gate.yml
  #     Parameters:
  #       projectName: !Ref projectName
  #       vpc: !GetAtt VPC.Outputs.vpc
  #       eC2KeyPair: !Ref eC2KeyPair
  #       publicSubnet: !GetAtt VPC.Outputs.publicSubnet1
  #       EFSFileSystem: !GetAtt EFS.Outputs.EFSFileSystem

  # Lambda:
  #   Type: AWS::CloudFormation::Stack
  #   Properties:
  #     TemplateURL: 03_lambda.yml
  #     Parameters:
  #       projectName: !Ref projectName
  #       vpc: !GetAtt VPC.Outputs.vpc
  #       publicSubnet1: !GetAtt VPC.Outputs.publicSubnet1
  #       publicSubnet2: !GetAtt VPC.Outputs.publicSubnet2
  #       privateSubnet1: !GetAtt VPC.Outputs.privateSubnet1
  # ECS:
  #   Type: AWS::CloudFormation::Stack
  #   Properties:
  #     TemplateURL: 04_ecs.yml
  #     Parameters:
  #       projectName: !Ref projectName
  #       vpc: !GetAtt VPC.Outputs.vpc
  #       publicSubnet1: !GetAtt VPC.Outputs.publicSubnet1
  #       publicSubnet2: !GetAtt VPC.Outputs.publicSubnet2
  #       privateSubnet1: !GetAtt VPC.Outputs.privateSubnet1
          Ref: projectName
  CLB:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.ap-southeast-1.amazonaws.com/mackerel-bucket/5edb389c39afca8e644fc4859c50c171.template
      Parameters:
        projectName:
          Ref: projectName
        vpc:
          Fn::GetAtt:
          - VPC
          - Outputs.vpc
        publicSubnet1:
          Fn::GetAtt:
          - VPC
          - Outputs.publicSubnet1
        publicSubnet2:
          Fn::GetAtt:
          - VPC
          - Outputs.publicSubnet2
        privateSubnet1:
          Fn::GetAtt:
          - VPC
          - Outputs.privateSubnet1
  Elasticache:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.ap-southeast-1.amazonaws.com/mackerel-bucket/52dafd4c7067af539cb47a6860112d3e.template
      Parameters:
        projectName:
          Ref: projectName
        vpc:
          Fn::GetAtt:
          - VPC
          - Outputs.vpc
        publicSubnet1:
          Fn::GetAtt:
          - VPC
          - Outputs.publicSubnet1
        publicSubnet2:
          Fn::GetAtt:
          - VPC
          - Outputs.publicSubnet2
        privateSubnet1:

          Fn::GetAtt:
          - VPC
          - Outputs.privateSubnet1
Outputs:
  # SSHGateIP:
  #   Value: !GetAtt SSHGate.Outputs.SSHGateIP
  # LambdaURL:
  #   Value: !GetAtt Lambda.Outputs.LambdaURL
  # NginxURL:
  #   Value: !GetAtt ECS.Outputs.NginxURL
  CLBURL:
    Value:

      Fn::GetAtt:
      - CLB
      - Outputs.CLBURL
